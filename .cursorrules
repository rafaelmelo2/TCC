# Cursor Rules - TCC: Predi√ß√£o Autom√°tica de Indicativos Financeiros para Bolsa de Valores

## Contexto do Projeto

Este √© um projeto de TCC (Trabalho de Conclus√£o de Curso) sobre **Predi√ß√£o Autom√°tica de Indicativos Financeiros para Bolsa de Valores Considerando o Aspecto Temporal**.

**Objetivo Principal**: Desenvolver e avaliar um modelo h√≠brido CNN+LSTM para prever a dire√ß√£o de movimentos de pre√ßos intradi√°rios (barras de 15 minutos) em a√ß√µes l√≠quidas da B3 (Brasil, Bolsa, Balc√£o).

**Per√≠odo dos Dados**: Janeiro/2020 a Julho/2025
**Granularidade**: Barras de 15 minutos (com an√°lises de sensibilidade em 5m e 30m)
**Ativos**: A√ß√µes l√≠quidas da B3 (PETR4, VALE3, ITUB4, etc.)

## Estrutura do Projeto

```
codigo/pipeline/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                    # Arquitetura do modelo CNN-LSTM h√≠brido
‚îÇ   ‚îú‚îÄ‚îÄ train.py                   # Script de treinamento
‚îÇ   ‚îú‚îÄ‚îÄ backtest.py                # Backtests com custos de transa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ data_processing/           # Pr√©-processamento e engenharia de features
‚îÇ   ‚îú‚îÄ‚îÄ models/                    # Modelos baseline (ARIMA, Prophet, Naive, LSTM)
‚îÇ   ‚îî‚îÄ‚îÄ generate_text_for_ia_by_pdf/  # Documenta√ß√£o do TCC
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ raw/                       # Dados brutos (CSV com OHLCV)
‚îÇ   ‚îî‚îÄ‚îÄ processed/                 # Dados processados e resultados
‚îú‚îÄ‚îÄ models/                        # Modelos treinados salvos (.keras)
‚îî‚îÄ‚îÄ examples/                      # Exemplos de uso dos modelos baseline
```

## Metodologia (Conforme TCC - Cap√≠tulo 4)

### 1. Valida√ß√£o Walk-Forward (OBRIGAT√ìRIA)
- **SEMPRE** usar valida√ß√£o walk-forward com embargo temporal
- Dividir dados em blocos sequenciais temporais
- Treinar no bloco k, validar internamente, aplicar embargo de h barras, testar em k+1
- **NUNCA** usar valida√ß√£o cruzada tradicional (k-fold) - viola ordem temporal
- Implementar conforme Figura 8 do TCC (Se√ß√£o 3.2)

### 2. Preven√ß√£o de Data Leakage (CR√çTICO)
- Normaliza√ß√£o (Min-Max ou Z-Score) deve ser ajustada **APENAS** nos dados de treino
- Aplicar transforma√ß√µes do treino ao conjunto de teste (fit no treino, transform no teste)
- **NUNCA** usar informa√ß√µes futuras para prever o passado
- Manter embargo temporal entre treino/valida√ß√£o e teste

### 3. Engenharia de Features (Se√ß√£o 4.2)
Features obrigat√≥rias a calcular:
- OHLCV (Abertura, M√°xima, M√≠nima, Fechamento, Volume)
- Retornos logar√≠tmicos: `rt = ln(Pt) - ln(Pt-1)`
- Volatilidade m√≥vel (janela de 20 per√≠odos)
- MME (M√©dias M√≥veis Exponenciais): 9, 21, 50 per√≠odos
- RSI (Relative Strength Index): 9, 21, 50 per√≠odos
- Bandas de Bollinger (20 per√≠odos, 2 desvios-padr√£o)
- Features derivadas: largura das bandas, posi√ß√£o relativa

### 4. Arquitetura do Modelo Proposto (CNN-LSTM)
```python
# Estrutura base (main.py):
- Conv1D: Extra√ß√£o de padr√µes locais (filters=64, kernel_size=2)
- MaxPooling1D: Redu√ß√£o de dimensionalidade (pool_size=2)
- LSTM: Depend√™ncias de longo prazo (50 unidades, dropout=0.2)
- Dense(1, sigmoid): Classifica√ß√£o bin√°ria (dire√ß√£o: alta/baixa)
- Otimizador: AdamW (learning_rate=0.001)
- Loss: binary_crossentropy
- Janela temporal: n_steps=60 barras (15 min cada)
- Features: n_features=12
```

### 5. M√©tricas de Avalia√ß√£o (Se√ß√£o 4.5)
**M√©tricas Principais**:
- Acur√°cia direcional (hit rate) com banda morta (dead band)
- Brier Score (qualidade probabil√≠stica)
- Log-Loss (calibra√ß√£o)
- Balanced Accuracy (robustez a classes desbalanceadas)
- F1-Score, MCC (Matthews Correlation Coefficient)
- AUC-PR (√Årea sob curva Precis√£o-Revoca√ß√£o)

**M√©tricas de Trading** (p√≥s-custos):
- Retorno l√≠quido (ap√≥s custos de transa√ß√£o e slippage)
- √çndice de Sharpe
- Maximum Drawdown
- Profit Factor
- Turnover

**Banda Morta (Dead Band)**:
- Zona neutra em torno do limiar para ignorar microvaria√ß√µes
- Implementar como: `|retorno_real| < threshold` ‚Üí classe neutra (n√£o conta como acerto/erro)
- Valor sugerido: 0.1% do pre√ßo (0.001) ou R$ 0.05 absoluto

### 6. Baselines para Compara√ß√£o
Modelos que DEVEM ser implementados e comparados:
1. **Naive/Drift** (Baseline 0): Repetir √∫ltimo valor ou drift linear
2. **ARIMA** (Baseline 1): Modelo estat√≠stico Box-Jenkins
3. **Prophet** (Baseline 2): Decomposi√ß√£o aditiva com sazonalidades
4. **LSTM Puro** (Baseline 3): LSTM sem camadas convolucionais
5. **CNN-LSTM H√≠brido** (Proposta): Modelo principal

## Padr√µes de C√≥digo

### Conven√ß√µes de Nomenclatura
- **Fun√ß√µes**: snake_case (ex: `calcular_features_tecnicas`)
- **Classes**: PascalCase (ex: `WalkForwardValidator`)
- **Constantes**: UPPER_SNAKE_CASE (ex: `N_STEPS = 60`)
- **Vari√°veis**: snake_case (ex: `df_features`)

### Estrutura de Fun√ß√µes
```python
def nome_funcao(parametros):
    """
    Descri√ß√£o clara e concisa da fun√ß√£o.
    
    Conforme metodologia do trabalho (Se√ß√£o X.Y do TCC).
    
    Par√¢metros:
        parametro1: Descri√ß√£o (tipo esperado)
        parametro2: Descri√ß√£o (tipo esperado)
        
    Retorna:
        Descri√ß√£o do retorno (tipo)
        
    Exce√ß√µes:
        TipoErro: Quando ocorre
    """
    # Implementa√ß√£o
    pass
```

### Imports e Organiza√ß√£o
```python
# 1. Bibliotecas padr√£o
import os
import sys

# 2. Bibliotecas de terceiros
import numpy as np
import pandas as pd
import tensorflow as tf
from sklearn.metrics import accuracy_score

# 3. M√≥dulos locais
from data_processing.load_data import carregar_dados
from models.arima_model import treinar_arima
```

### Tratamento de Dados Temporais
- **SEMPRE** usar √≠ndices temporais (DatetimeIndex) em DataFrames
- Validar ordem cronol√≥gica antes de processar
- Remover ou tratar valores ausentes (NaN) explicitamente
- Documentar ajustes corporativos (splits, dividendos)

### Logging e Debugging
- Usar `print()` com prefixos `[OK]`, `[!]`, `[ERRO]` para feedback visual
- Documentar progresso em etapas numeradas: `[1/7]`, `[2/7]`, etc.
- Salvar logs de experimentos com timestamps
- Versionar modelos e resultados com identificadores √∫nicos

## Regras Espec√≠ficas do Dom√≠nio Financeiro

### 1. Dados Intradi√°rios
- Respeitar hor√°rios de preg√£o da B3 (10:00 √†s 17:00, hor√°rio de Bras√≠lia)
- Considerar periodicidade intradi√°ria (picos na abertura/fechamento)
- Remover barras com volume zero ou pre√ßos an√¥malos (spikes esp√∫rios)

### 2. Custos de Transa√ß√£o
- Incluir custos fixos (corretagem) e proporcionais (emolumentos)
- Aplicar slippage realista (0.05% a 0.1% do valor negociado)
- Calcular custos conforme estrutura da B3 (Manual de Procedimentos Operacionais)

### 3. Valida√ß√£o Temporal
- **NUNCA** embaralhar dados (shuffle) - viola ordem temporal
- Usar `TimeSeriesSplit` do scikit-learn ou implementa√ß√£o customizada
- Manter embargo temporal (h = horizonte de previs√£o, geralmente 1 barra)

### 4. Reprodutibilidade
- Fixar seeds: `np.random.seed(42)`, `tf.random.set_seed(42)`
- Versionar depend√™ncias (requirements.txt, pyproject.toml)
- Documentar vers√µes de bibliotecas cr√≠ticas (TensorFlow, pandas, etc.)
- Salvar configura√ß√µes de experimentos (JSON/YAML)

## Bibliotecas e Vers√µes

### Principais Depend√™ncias
- Python >= 3.10
- pandas >= 2.0.0
- numpy >= 1.24.0
- tensorflow >= 2.14.0
- scikit-learn >= 1.3.0
- statsmodels >= 0.14.0 (ARIMA)
- matplotlib >= 3.7.0 (visualiza√ß√µes)
- optuna >= 3.0.0 (otimiza√ß√£o bayesiana)

### Gerenciamento de Pacotes
- **Usar `uv` como gerenciador principal** (ferramenta de Python moderna e r√°pida)
- Instalar depend√™ncias com: `uv pip install -r requirements.txt` ou `uv sync` (se usando pyproject.toml)
- Manter `requirements.txt` para compatibilidade com pip e refer√™ncia
- Usar `pyproject.toml` para configura√ß√£o do projeto (quando aplic√°vel)
- O UV √© usado para todas as opera√ß√µes de gerenciamento de ambiente e pacotes Python

## Cronograma e Status Atual

**Per√≠odo**: Setembro/2025 - Janeiro/2026

**Etapas Conclu√≠das** (Set/Out 2025):
- ‚úÖ Aquisi√ß√£o e auditoria de dados (2020-2025, 15m)
- ‚úÖ Pr√©-processamento e engenharia de atributos
- ‚úÖ Implementa√ß√£o de baselines (Naive, ARIMA, Prophet)
- ‚úÖ Implementa√ß√£o do modelo CNN-LSTM h√≠brido
- ‚úÖ Scripts de treinamento b√°sicos

**Etapas em Andamento** (Nov 2025):
- üîÑ Valida√ß√£o walk-forward completa com embargo temporal
- üîÑ Otimiza√ß√£o bayesiana de hiperpar√¢metros (Optuna)
- üîÑ Avalia√ß√£o preditiva completa (m√©tricas da Se√ß√£o 4.5)
- üîÑ Backtests com custos de transa√ß√£o

**Pr√≥ximas Etapas** (Dez 2025 - Jan 2026):
- ‚è≥ Testes de robustez (Diebold-Mariano, regimes de volatilidade)
- ‚è≥ An√°lises de sensibilidade (5m, 30m, diferentes ativos)
- ‚è≥ Reprodutibilidade final (documenta√ß√£o, versionamento)
- ‚è≥ Reda√ß√£o de Resultados e Discuss√£o

## Diretrizes para Desenvolvimento

### Ao Implementar Novas Funcionalidades
1. **Consultar o TCC primeiro**: Verificar se√ß√£o relevante em `generate_text_for_ia_by_pdf/`
2. **Seguir metodologia**: Implementar conforme Cap√≠tulo 4 (Pr√≥ximos Passos)
3. **Validar temporalmente**: Sempre usar walk-forward, nunca k-fold tradicional
4. **Documentar**: Adicionar docstrings explicando rela√ß√£o com metodologia
5. **Testar**: Validar com dados conhecidos antes de aplicar em produ√ß√£o

### Ao Modificar C√≥digo Existente
1. **Manter compatibilidade**: N√£o quebrar scripts de treinamento existentes
2. **Preservar valida√ß√£o temporal**: N√£o introduzir data leakage
3. **Atualizar documenta√ß√£o**: Refletir mudan√ßas em coment√°rios/docstrings
4. **Versionar**: Commitar mudan√ßas com mensagens descritivas

### Ao Criar Novos Modelos
1. **Implementar walk-forward**: Obrigat√≥rio para todos os modelos
2. **Comparar com baselines**: Sempre incluir Naive, ARIMA, Prophet
3. **Calcular todas as m√©tricas**: Hit rate, Brier, Log-Loss, Sharpe, etc.
4. **Salvar resultados**: CSV com previs√µes e m√©tricas por fold
5. **Gerar visualiza√ß√µes**: Gr√°ficos comparativos e curvas de calibra√ß√£o

### Ao Fazer Backtests
1. **Incluir custos realistas**: Corretagem, emolumentos, slippage
2. **Testar estrat√©gias**: Long-only e long/short
3. **Calcular m√©tricas financeiras**: Retorno, Sharpe, drawdown, turnover
4. **An√°lise de sensibilidade**: Varia√ß√µes de custos e thresholds
5. **Documentar suposi√ß√µes**: Explicar regras de entrada/sa√≠da

## Refer√™ncias Importantes

### Documenta√ß√£o do TCC
- Arquivo principal: `D:\Rafael\TCC\codigo\pipeline\others\generate_text_for_ia_by_pdf\Predi√ß√£o_Autom√°tica_de_Indicativos_Financeiros_para_Bolsa_de_Valores_Considerando_o_Aspecto_Temporal___Rafael_da_Silva_Melo___2025.txt`
- Se√ß√£o 4: Pr√≥ximos Passos (metodologia detalhada)
- Se√ß√£o 4.4: Desenho Experimental e Treinamento
- Se√ß√£o 4.5: M√©tricas de Avalia√ß√£o
- Se√ß√£o 3.2: Valida√ß√£o walk-forward (Figura 8)


## Notas Finais

- **Sempre priorizar reprodutibilidade**: C√≥digo deve ser execut√°vel por qualquer pessoa
- **Manter foco na metodologia**: Seguir rigorosamente o protocolo do TCC
- **Validar resultados**: Comparar com literatura e baselines estabelecidos
- **Documentar decis√µes**: Explicar escolhas arquiteturais e de hiperpar√¢metros
- **Testar robustez**: Validar em diferentes regimes de mercado e ativos

---

**√öltima atualiza√ß√£o**: Novembro 2025
**Autor**: Rafael da Silva Melo
**Orientador**: Prof. Dr. M√°rcio de Souza Dias
